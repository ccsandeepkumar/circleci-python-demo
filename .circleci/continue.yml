version: 2.1

parameters:
  run-tests:
    type: boolean
    default: false

jobs:
  build-and-test:
    docker:
      # Pin to a specific 3.9 patch to avoid implicit upgrades
      - image: cimg/python:3.9.18

    steps:
      - checkout

      - run:
          name: Verify runtime (python & pip)
          command: |
            set -eo pipefail
            echo "PATH: $PATH"
            which python || true
            python --version || true
            which pip || true
            pip --version || true

      - run:
          name: Install dependencies (fresh venv on Python 3.9)
          command: |
            set -eo pipefail
            # Remove any stale venv to avoid 3.8 carry-over
            rm -rf venv
            python --version
            python -m venv venv
            . venv/bin/activate
            python -m pip install --upgrade pip
            if [ -f requirements.txt ]; then
              pip install -r requirements.txt
            else
              pip install pytest
            fi

      - run:
          name: Run tests from test_list.py
          command: |
            set -eo pipefail
            . venv/bin/activate
            if [ ! -f test_list.py ]; then
              echo "test_list.py not found at repository root"; exit 1
            fi
            TESTS=$(python test_list.py || true)

            if [ -z "$TESTS" ]; then
              echo "No tests returned by test_list.py; skipping pytest."
              exit 0
            fi

            echo "Running tests:"
            echo "$TESTS"
            echo "$TESTS" | xargs pytest -v

workflows:
  version: 2.1
  conditional-workflow:
    when: << pipeline.parameters.run-tests >>
    jobs:
      - build-and-test
