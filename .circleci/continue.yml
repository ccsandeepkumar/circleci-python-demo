version: 2.1

parameters:
  run-tests:
    type: boolean
    default: false

jobs:
  build-and-test:
    docker:
      - image: cimg/python:3.9

    steps:
      - checkout

      - run:
          name: Verify Python version
          command: python --version

      - run:
          name: Install dependencies
          command: |
            set -eo pipefail
            python -m venv venv
            . venv/bin/activate
            python -m pip install --upgrade pip
            if [ -f requirements.txt ]; then
              pip install -r requirements.txt
            else
              # Ensure pytest is available even if requirements.txt is missing
              pip install pytest
            fi

      - run:
          name: Run tests from test_list.py
          command: |
            set -eo pipefail
            . venv/bin/activate

            if [ ! -f test_list.py ]; then
              echo "test_list.py not found at repository root"; exit 1
            fi

            TESTS=$(python test_list.py || true)

            if [ -z "$TESTS" ]; then
              echo "No tests returned by test_list.py; skipping pytest."
              # Exit 0 to avoid failing the pipeline when nothing is selected
              exit 0
            fi

            echo "Running tests:"
            echo "$TESTS"

            # Use xargs to safely handle spaces/newlines in the output
            echo "$TESTS" | xargs pytest -v

workflows:
  version: 2.1
  conditional-workflow:
    when: << pipeline.parameters.run-tests >>
    jobs:
      - build-and-test
